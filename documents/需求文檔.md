系統升級需求文檔
一、專案概述
為了將現有系統由「被動監控」升級為「主動掃描」並解決現存維護問題，本方案整合以下三大方向：

多源數據與交易架構升級：導入 Polygon.io 與 Alpha Vantage，實作三層數據架構與分層監控。

基礎設施與程式品質改善：修復套件管理、API 憑證、日誌與 CI 等問題。

風險控管與 ROI 驗證機制：確保新增成本能在可接受的期間內回收並降低資安風險。

二、系統功能與技術規格
1. 多源數據與三層架構
歷史訓練層：Alpha Vantage 提供 20 年歷史與基本面資料，用於模型訓練與回測。

實時信號層：Polygon.io 提供毫秒級報價與掃描功能，主動發掘全市場機會。

執行驗證層：Capital.com 僅在最終下單前作價格確認與執行。

2. 分層監控與動態調度
S 級監控（40 支）：WebSocket 實時連線（持倉、熱度高股票）。

A 級監控（100 支）：1 分鐘輪詢（觀察清單、高勝率股票）。

B 級監控（4,000+ 支）：5 分鐘批量掃描（全市場覆蓋）。

動態優先級調整：依據信號強度與市場波動度，每小時重新分配監控層級。

3. 信號驗證與緩存
信號來源一致性：Polygon 生成 → Capital 驗證 → 下單。

智能緩存：減少重複 API 呼叫，避免速率限制並降低延遲。

三、基礎架構與程式品質改善需求
1. 依賴與套件管理
明確鎖定依賴版本，修正 CI 需引用的檔案。

移除大型二進位檔與資料檔在 Git 版本控制。

2. 安全與設定
移除明文 API 憑證，改用環境變數與 .env 文件。

3. 程式設計
全系統改用 logging，避免使用全域物件。

封裝專案為可安裝套件，移除 sys.path 操作並補完 TODO。

4. CI/CD
修正或新增 requirements-secure.txt，確保流程可在乾淨環境中執行。

四、執行步驟與時間規劃
| 週次  | 里程碑     | 主要內容             |
| --- | ------- | ---------------- |
| 1-2 | 數據管道建立  | API 連線、同步機制、品質檢查 |
| 3-4 | 分層監控完成  | S/A/B 級監控及動態調度   |
| 5-6 | 信號優化與部署 | 信號驗證、智能緩存、RO測試   |
| 6+  | 長期維護    | 測試、文件化、資安掃描      |

五、風險與回報
風險點：數據偏差、API 速率限制、成本失控。

應對措施：價差容忍機制、緩存與排程、設置 ROI 監控機制。

六、詳細工作項目（含 Task Stubs）
A. 多源數據與架構升級
A1. 整合 Polygon.io 與 Alpha Vantage
1. 在 `data_pipeline/` 下建立 `polygon_client.py` 與 `alpha_vantage_client.py`，處理 API 認證與資料抓取。
2. 在 `data_pipeline/__init__.py` 中提供統一介面 `get_historical_data`、`stream_realtime_data`。
3. 撰寫單元測試驗證資料整合與錯誤處理。
A2. 分層監控與動態調度
1. 新增 `monitoring/scheduler.py`，內含 `TieredMonitor` 類別與排程邏輯。
2. 在 `monitoring/config.yaml` 定義 S/A/B 級規則與閾值。
3. 實作每小時重新分配監控層級的函式 `rebalance_watchlist()`。
A3. 信號驗證與緩存
1. 在 `signals/validator.py` 中實作 `validate_with_capital(price, symbol)` 比對 Polygon 信號。
2. 加入 `signals/cache.py` 管理 API 回應快取，避免速率限制。
3. 整合至主交易流程 `src/trader.py`，於下單前進行多源驗證。

B. 基礎設施與程式品質改善
B1. 依賴管理
1. 編輯 `requirements.txt`，對 `numpy`, `pandas`, `torch` 等核心套件改為 `==` 固定版本。
2. 若需要安全依賴清單，新增 `requirements-secure.txt`；否則移除 CI 中相關引用。
3. 確保檔案末行含換行符並提交。

B2. API 憑證管理
1. 移除 `config/api_config.json` 中的 `api_key`、`password` 欄位。
2. 在程式內改用 `os.getenv('API_KEY')`、`os.getenv('API_SECRET')` 讀取。
3. 新增 `.env.example` 示範檔與相關文件。

B3. Logging 與全域狀態
1. 在 `src/capital_service.py` 將 `print` 改成 `logging.getLogger(__name__)`。
2. 移除 `_service` 全域物件，改為由呼叫端建立 `CapitalService`。
3. 新增單元測試 `tests/test_capital_service.py` 覆蓋錯誤處理與日誌。

B4. 封裝與 TODO 移除
1. 在 `src/` 新增 `__init__.py` 與 `pyproject.toml`，轉為可安裝套件。
2. 移除 `main_trading.py` 的 `sys.path.append`，改用標準匯入。
3. 依 TODO 說明實作實盤交易與回測流程，或刪除無用註解。

B5. 大型檔案管理
1. 將 `ppo_trader_iter_*.pt`、`historical_data/` 移至 Git LFS 或外部儲存。
2. 更新 `.gitignore` 排除上述檔案路徑。
3. 在部署腳本新增下載或同步步驟。

B6. CI 依賴修正
1. 檢查 `.github/workflows/ci-cd.yml` 中 `pip install -r requirements-secure.txt` 步驟。
2. 若無此檔案，移除或改為指向 `requirements.txt`。
3. 在乾淨環境（如 GitHub Actions）測試流程是否成功。

七、驗收標準
技術：API 連線成功率 >99%，數據延遲 <1 秒，偽信號率下降 >20%。

效益：監控股票數 >4,000 支，月收益提升 ≥15%，ROI ≥1,000%。

維運：程式覆蓋單元測試，CI/CD 通過率 100%，憑證無硬編碼。

八、後續維護與擴充
定期監測 API 成本與效益，若 ROI <500% 兩個月，啟動降級方案。

擴充自動化部署與資安掃描（如依賴漏洞檢查、鏡像掃描）。

持續更新模型與策略，並在文檔中記錄變更。
