# MT4 橋接設置指南

## 前置要求

### 1. MT4 安裝
- 下載 Capital.com MT4 交易平台
- 使用 Demo 帳戶登入
- 確保已連接到交易服務器

### 2. ZeroMQ 庫安裝

#### MT4 端 (必須)
1. 下載 ZeroMQ for MT4 庫文件:
   - `libzmq.dll` (32位版本，MT4是32位程序)
   - `libsodium.dll` (如果需要)

2. 將 DLL 文件複製到 MT4 安裝目錄:
   ```
   C:\Program Files (x86)\Capital.com MT4\MQL4\Libraries\
   ```

#### Python 端 (已安裝)
```bash
pip install pyzmq
```

## 設置步驟

### 步驟 1: 配置 MT4

1. **啟用自動交易**
   - 打開 MT4
   - 點擊 `工具` → `選項` → `Expert Advisors`
   - 勾選以下選項:
     - ☑ 允許自動交易
     - ☑ 允許DLL導入
     - ☑ 允許外部專家導入
   - 點擊 `確定`

2. **啟用 Algo Trading**
   - 在 MT4 工具欄點擊 `自動交易` 按鈕（應該顯示綠色）

### 步驟 2: 安裝 PythonBridge EA

1. **複製 EA 文件**
   ```
   將 mt4_bridge/mql4/PythonBridge.mq4 複製到:
   C:\Program Files (x86)\Capital.com MT4\MQL4\Experts\
   ```

2. **編譯 EA**
   - 在 MT4 中打開 MetaEditor (F4)
   - 打開 `PythonBridge.mq4`
   - 點擊 `編譯` 按鈕 (F7)
   - 確保沒有編譯錯誤

3. **載入 EA 到圖表**
   - 返回 MT4 主界面
   - 打開任意圖表（建議使用主要貨幣對如 EUR/USD）
   - 從導航器窗口拖拽 `PythonBridge` EA 到圖表
   - 在彈出的設置窗口中:
     - 確保 `允許自動交易` 已勾選
     - 確保 `允許DLL導入` 已勾選
     - 檢查參數設置（使用默認值即可）
   - 點擊 `確定`

4. **驗證 EA 運行**
   - 圖表右上角應顯示笑臉符號 😊
   - 查看 `專家` 標籤，應看到初始化成功消息

### 步驟 3: 測試連接

1. **運行測試腳本**
   ```bash
   cd C:\Users\niuji\Documents\QuantProject
   python mt4_bridge\test_mt4_bridge.py
   ```

2. **檢查測試結果**
   - 基本連接測試: 驗證 ZeroMQ 通訊
   - 帳戶信息測試: 獲取帳戶餘額等信息
   - 數據流測試: 接收實時 Tick 和 K線數據
   - 交易信號測試: 測試命令發送（不實際交易）

## 故障排除

### 問題 1: 無法連接到 MT4
**症狀**: Python 無法連接到 MT4
**解決方案**:
- 確保 MT4 已啟動並登入
- 確保 EA 已載入到圖表
- 確保自動交易已啟用（綠色按鈕）
- 檢查防火牆設置，允許本地端口 5555-5558

### 問題 2: DLL 載入錯誤
**症狀**: EA 顯示 DLL 載入失敗
**解決方案**:
- 確保 `libzmq.dll` 在正確位置
- 確保使用 32 位版本的 DLL
- 在 MT4 選項中啟用 DLL 導入
- 以管理員權限運行 MT4

### 問題 3: 沒有數據流
**症狀**: Python 接收不到 Tick 數據
**解決方案**:
- 確保市場開市（週末無數據）
- 檢查 EA 參數中的數據發送選項
- 查看 MT4 專家標籤的錯誤消息

### 問題 4: 心跳超時
**症狀**: 連接經常斷開
**解決方案**:
- 檢查網絡連接穩定性
- 調整心跳間隔參數
- 確保電腦不會進入睡眠模式

## 端口配置

默認端口設置:
- REQ-REP (命令): 5555, 5556
- PUB-SUB (數據): 5557, 5558

如需修改端口:
1. 在 EA 參數中修改端口號
2. 在 Python 配置文件中相應修改

## 安全注意事項

1. **僅用於 Demo 帳戶測試**
   - 在實盤交易前充分測試
   - 確保風險管理機制正常

2. **本地連接**
   - 默認僅允許本地連接 (localhost)
   - 不要暴露端口到公網

3. **錯誤處理**
   - 實現完善的錯誤處理
   - 記錄所有交易操作

## 下一步

設置完成後，您可以:
1. 運行數據收集系統
2. 測試交易策略
3. 整合到現有量化系統
4. 開發自定義 EA 功能

## 支援

如遇到問題:
1. 查看 MT4 專家標籤的日誌
2. 查看 Python 控制台輸出
3. 檢查 `mt4_bridge/logs/` 目錄的日誌文件
4. 參考錯誤代碼對照表